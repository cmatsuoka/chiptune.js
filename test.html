<!DOCTYPE html>
<html>
<head>
<style>
  * {
    font-family: sans-serif;
  }

  #dropzone {
    width: 300px;
    height: 200px;
    background-color: #eee;
    border: 1px dashed #999;
    margin: 0px auto;
    display: table;
  }

  #dropzone * {
    display: table-cell;
    vertical-align: middle;
    text-align: center;
    color: #aaa;
    z-index: 300;
    position: relative;
  }

  #canvas {
    height: 200px;
    width: 300px;
    margin: 0px auto;
    display: block;
    position: relative;
    top: -201px;
    z-index: 200;
  }

</style>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="libxmp.js"></script>
<script type="text/javascript">

$(function () {
  var fileaccess = document.querySelector("#dropzone");

  fileaccess.ondrop = function(e) {
      var file = e.dataTransfer.files[0];
      var reader = new FileReader();
      reader.onload = function() {
        try {
          FS.deleteFile("/foo")
        } catch(err) {}
        FS.createDataFile('/','foo', new Int8Array(reader.result), true, true);
        player_ptr = xmp.play_file("/foo");
        $('#pause').click(function() {
          xmp.pause(player_ptr);
        });
        $('#resume').click(function() {
          xmp.resume(player_ptr);
        });
      }
      reader.readAsArrayBuffer(file);
      e.preventDefault();
  }
  fileaccess.ondragenter = function(e){e.preventDefault();}
  fileaccess.ondragover = function(e){e.preventDefault();}

  // support webkit-prefix for chrome
  if (window.webkitAudioContext !== undefined) {
    AudioContext = webkitAudioContext;
  }
  var context = new AudioContext();
  var analyser = context.createAnalyser();
  analyser.connect(context.destination);
  analyser.fftSize = 128;

  var setup = true;

  function update() {
    requestAnimationFrame(update);
    if(!setup) return;
    gfx.clearRect(0,0,800,600);
    gfx.fillStyle = '#eee';
    gfx.fillRect(0,0,800,600);

    var data = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    gfx.fillStyle = '#555';
    for(var i=0; i<data.length; i++) {
        gfx.fillRect(1+i*5, data[i], 4, (data[i] / 255) * 90 + 20);
    }
  }

  var canvas = document.getElementById('canvas');
  gfx = canvas.getContext('2d');
  requestAnimationFrame(update);

  // Read data from the player and pack it into a suitable format
  var get_audio_source = function(player_ptr) {
    // Helper: Read one chunk from player
    var get_buffer = function(player_ptr) {
      // Helper: Retreive data from buffer as Float32Array
      var get_data = function(buf_ptr) {
        var data_ptr = Module.getValue(buf_ptr, '*');
        var size = Module.getValue(buf_ptr + 4, 'i32');
        if (size == 0  || data_ptr == 0) return;

        var i8Array = Module.HEAP8.subarray(data_ptr, data_ptr + size);
        return new Float32Array(i8Array.buffer, data_ptr, size / 4);
      }

      var buf_ptr = xmp.read(player_ptr);
      var ret = get_data(buf_ptr);
      xmp.free_buffer(buf_ptr);
      return ret;
    }

    // Append a number of audio chunks
    var raw_audio = get_buffer(player_ptr);
    if (raw_audio === undefined) return;

    for (var i = 0; i < 64; i++) {
      var new_data = get_buffer(player_ptr);
      if (new_data === undefined) break;
      var old_data = raw_audio;
      raw_audio = new Float32Array(old_data.length + new_data.length);
      raw_audio.set(old_data, 0);
      raw_audio.set(new_data, old_data.length);
    }
    delete new_data;
    delete old_data;

    // Create a JS AudioBuffer
    var audio_buffer = context.createBuffer(1, raw_audio.length, 44100);
    audio_buffer.getChannelData(0).set(raw_audio);

    // Put it into a JS BufferSource
    var source = context.createBufferSource();
    source.buffer = audio_buffer;
    source.connect(analyser);
    return source;
  }

  var xmp = {
    init: Module.cwrap('initialize_player', 'number', ['string']),
    read: Module.cwrap('read_from_player', 'number', ['number']),
    free_buffer: Module.cwrap('free_buffer', 'null', ['number']),
    free_player: Module.cwrap('free_player', 'null', ['number']),
    player_data: {},
    get_audio_source: get_audio_source,
    play: function(player_ptr, last_chunk, first_run) {
      // Fill buffer on first run
      if (first_run) {
        xmp.player_data[player_ptr] = {};
        xmp.player_data[player_ptr].next_src = xmp.get_audio_source(player_ptr);
      }

      // no more data -> clean up
      if (!xmp.player_data[player_ptr].next_src) {
        xmp.free_player(player_ptr);
        return;
      }

      // play!
      if (!xmp.player_data[player_ptr].pause) {
        var duration = xmp.player_data[player_ptr].next_src.buffer.duration;
        var last_chunk = first_run ? context.currentTime : last_chunk + duration;
        xmp.player_data[player_ptr].last_src = xmp.player_data[player_ptr].current_src;
        xmp.player_data[player_ptr].current_src = xmp.player_data[player_ptr].next_src;

        xmp.player_data[player_ptr].current_src.start(last_chunk);
        xmp.player_data[player_ptr].current_src.timeScheduled = last_chunk;

        // schedule next chunk
        setTimeout(xmp.play.bind(this, player_ptr, last_chunk), first_run ? (duration * 1000) / 2 : (duration * 1000));

        // fill buffer while playing
        xmp.player_data[player_ptr].next_src = xmp.get_audio_source(player_ptr);
      }
    },
    pause: function(player_ptr) {
      xmp.player_data[player_ptr].pause = context.currentTime;
      xmp.player_data[player_ptr].last_src.stop(0);
      xmp.player_data[player_ptr].current_src.stop(0);
      xmp.player_data[player_ptr].next_src.stop(0);
    },
    resume: function(player_ptr) {
      var current_offset = context.currentTime - xmp.player_data[player_ptr].current_src.timeScheduled;

      if (current_offset < xmp.player_data[player_ptr].current_src.buffer.duration) {
        var new_src = context.createBufferSource();
        new_src.buffer = xmp.player_data[player_ptr].current_src.buffer;
        new_src.connect(analyser);
        new_src.start(0);
      }
      xmp.player_data[player_ptr].pause = false;
      xmp.play(player_ptr, 0, false);
    },
    play_file: function(filename) {
      // Initialize player
      var player_ptr = xmp.init(filename);
      if (player_ptr == 0) return;

      // Start playing
      xmp.play(player_ptr, context.currentTime, true);
      return player_ptr;
    }
  };

  var play_remote_file = function(path) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', path, true);
    xhr.responseType = 'arraybuffer';

    xhr.onload = function(e) {
      FS.createDataFile('/','foo', new Int8Array(xhr.response), true, true);
      var player_ptr = xmp.play_file("/foo");
    };

    xhr.send();
  }

});
</script>
</head>
<body>
  <div id="dropzone">
    <h3>Drop your module here!</h3>
  </div>
  <canvas id="canvas"></canvas>
  <button id="pause">Pause</button>
  <button id="resume">Resume</button>
</body>
</html>

